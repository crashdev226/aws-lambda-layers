version: '3.7'

services:
  bref-fpm:
    container_name: ${ARCHITECTURE}-bref-package
    image: bref/fpm-source-package
    build:
      context: ..
      dockerfile: runtime/docker/fpm/Fpm.Dockerfile
    volumes:
      - ./tests:/tests

  php74-ext-fpm:
    image: bref/${ARCHITECTURE}-php74-ext-fpm
    build:
      context: ..
      dockerfile: runtime/docker/ext-${ARCHITECTURE}/ext.fpm.Dockerfile
      args:
        - PHP_VERSION=php74

  php74-fpm:
    container_name: ${ARCHITECTURE}-php74-fpm
    image: bref/${ARCHITECTURE}-php74-fpm
    build:
      context: ..
      dockerfile: runtime/docker/fpm.Dockerfile
      args:
        - AWS_TAG
        - ARCHITECTURE
        - PHP_VERSION=php74
    command: fixture_fpm.php
    environment:
      - PHP_INI_SCAN_DIR=/opt/php-ini
      - PHP_VERSION=php74
    stop_grace_period: 0s
    working_dir: /var/task
    volumes:
      - ./tests:/tests
      - ./tests/integration:/var/task
      - ./tests/integration/fixture_php.ini:/var/task/php/conf.d/fixture_php.ini

  php74-fpm-config-tester:
    container_name: ${ARCHITECTURE}-php74-fpm-config-tester
    image: bref/${ARCHITECTURE}-php74-fpm
    entrypoint: /opt/bin/php-fpm
    command: ["--test", "--fpm-config", "/opt/php-fpm/php-fpm.conf"]

  php74-fpm-tester:
    container_name: ${ARCHITECTURE}-php74-fpm-tester
    image: bref/${ARCHITECTURE}-php74-fpm
    entrypoint: /opt/bin/php
    command: /tests/integration/test_invoke_fpm.php
    environment: [PHP_INI_SCAN_DIR=/opt/php-ini]
    working_dir: /tests
    links: [php74-fpm:php-fpm]
    volumes:
      - ./tests:/tests

  php74-fpm-zip:
    image: bref/${ARCHITECTURE}-php74-fpm-zip
    build:
      args:
        IMAGE: bref/${ARCHITECTURE}-php74-fpm
      context: ..
      dockerfile: runtime/publish/Zip.Dockerfile
    entrypoint: /bin/cp
    command: ["/tmp/layer.zip", "/tmp/bref-zip/fpm/php74-fpm-layer.zip"]
    volumes:
      - /tmp/bref-zip/:/tmp/bref-zip/

##################################

  php80-ext-fpm:
    image: bref/${ARCHITECTURE}-php80-ext-fpm
    build:
      context: ..
      dockerfile: runtime/docker/ext-${ARCHITECTURE}/ext.fpm.Dockerfile
      args:
        - PHP_VERSION=php80

  php80-fpm:
    container_name: ${ARCHITECTURE}-php80-fpm
    image: bref/${ARCHITECTURE}-php80-fpm
    build:
      context: ..
      dockerfile: runtime/docker/fpm.Dockerfile
      args:
        - AWS_TAG
        - ARCHITECTURE
        - PHP_VERSION=php80
    command: fixture_fpm.php
    environment:
      - PHP_INI_SCAN_DIR=/opt/php-ini
      - PHP_VERSION=php80
    stop_grace_period: 0s
    working_dir: /var/task
    volumes:
      - ./tests:/tests
      - ./tests/integration:/var/task
      - ./tests/integration/fixture_php.ini:/var/task/php/conf.d/fixture_php.ini

  php80-fpm-config-tester:
    container_name: ${ARCHITECTURE}-php80-fpm-config-tester
    image: bref/${ARCHITECTURE}-php80-fpm
    entrypoint: /opt/bin/php-fpm
    command: ["--test", "--fpm-config", "/opt/php-fpm/php-fpm.conf"]

  php80-fpm-tester:
    container_name: ${ARCHITECTURE}-php80-fpm-tester
    image: bref/${ARCHITECTURE}-php80-fpm
    entrypoint: /opt/bin/php
    command: /tests/integration/test_invoke_fpm.php
    environment: [PHP_INI_SCAN_DIR=/opt/php-ini]
    working_dir: /tests
    links: [php80-fpm:php-fpm]
    volumes:
      - ./tests:/tests

  php80-fpm-zip:
    image: bref/${ARCHITECTURE}-php80-fpm-zip
    build:
      args:
        IMAGE: bref/${ARCHITECTURE}-php80-fpm
      context: ..
      dockerfile: runtime/publish/Zip.Dockerfile
    entrypoint: /bin/cp
    command: ["/tmp/layer.zip", "/tmp/bref-zip/fpm/php80-fpm-layer.zip"]
    volumes:
      - /tmp/bref-zip/:/tmp/bref-zip/

##################################

  php81-ext-fpm:
    image: bref/${ARCHITECTURE}-php81-ext-fpm
    build:
      context: ..
      dockerfile: runtime/docker/ext-${ARCHITECTURE}/ext.fpm.Dockerfile
      args:
        - PHP_VERSION=php81

  php81-fpm:
    container_name: ${ARCHITECTURE}-php81-fpm
    image: bref/${ARCHITECTURE}-php81-fpm
    build:
      context: ..
      dockerfile: runtime/docker/fpm.Dockerfile
      args:
        - AWS_TAG
        - ARCHITECTURE
        - PHP_VERSION=php81
    command: fixture_fpm.php
    environment:
      - PHP_INI_SCAN_DIR=/opt/php-ini
      - PHP_VERSION=php81
    stop_grace_period: 0s
    working_dir: /var/task
    volumes:
      - ./tests:/tests
      - ./tests/integration:/var/task
      - ./tests/integration/fixture_php.ini:/var/task/php/conf.d/fixture_php.ini

  php81-fpm-config-tester:
    container_name: ${ARCHITECTURE}-php81-fpm-config-tester
    image: bref/${ARCHITECTURE}-php81-fpm
    entrypoint: /opt/bin/php-fpm
    command: ["--test", "--fpm-config", "/opt/php-fpm/php-fpm.conf"]

  php81-fpm-tester:
    container_name: ${ARCHITECTURE}-php81-fpm-tester
    image: bref/${ARCHITECTURE}-php81-fpm
    entrypoint: /opt/bin/php
    command: /tests/integration/test_invoke_fpm.php
    environment: [PHP_INI_SCAN_DIR=/opt/php-ini]
    working_dir: /tests
    links: [php81-fpm:php-fpm]
    volumes:
      - ./tests:/tests

  php81-fpm-zip:
    image: bref/${ARCHITECTURE}-php81-fpm-zip
    build:
      args:
        IMAGE: bref/${ARCHITECTURE}-php81-fpm
      context: ..
      dockerfile: runtime/publish/Zip.Dockerfile
    entrypoint: /bin/cp
    command: ["/tmp/layer.zip", "/tmp/bref-zip/fpm/php81-fpm-layer.zip"]
    volumes:
      - /tmp/bref-zip/:/tmp/bref-zip/